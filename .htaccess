# ============================================================================
# CRM LIGEROS v2.0 - CONFIGURACIÓN APACHE ACTUALIZADA
# .htaccess - Sistema con nueva estructura
# ============================================================================

# Activar motor de reescritura
RewriteEngine On

# Ocultar listado de directorios
Options -Indexes

# ============================================================================
# PROTECCIÓN DE ARCHIVOS SENSIBLES
# ============================================================================

# Proteger logs
<Files "*.log">
    Order Allow,Deny
    Deny from all
</Files>

# Proteger archivos SQL
<Files "*.sql">
    Order Allow,Deny
    Deny from all
</Files>

# Proteger archivos de configuración
<Files "config.php">
    Order Allow,Deny
    Deny from all
</Files>

<Files "app.php">
    Order Allow,Deny
    Deny from all
</Files>

<Files "security.php">
    Order Allow,Deny
    Deny from all
</Files>

# Proteger archivos de entorno
<Files "*.env*">
    Order Allow,Deny
    Deny from all
</Files>

# Proteger archivos de backup
<Files "*.bak">
    Order Allow,Deny
    Deny from all
</Files>

<Files "*.backup">
    Order Allow,Deny
    Deny from all
</Files>

# Proteger .htaccess
<Files ".htaccess">
    Order Allow,Deny
    Deny from all
</Files>

# Proteger directorios del core y app
RedirectMatch 403 ^/(app|core|storage|config)/.*$

# ============================================================================
# RUTAS DE LA APLICACIÓN v2.0
# ============================================================================

# Servir archivos estáticos directamente
RewriteCond %{REQUEST_FILENAME} -f
RewriteRule ^public/(.*)$ public/$1 [L]

# Permitir acceso directo a assets
RewriteRule ^assets/(.*)$ public/assets/$1 [L]

# Permitir acceso directo a uploads
RewriteRule ^uploads/(.*)$ public/uploads/$1 [L]

# Compatibilidad: permitir login.php directo temporalmente
RewriteRule ^login\.php$ login.php [L]

# API Routes - mantener funcionalidad existente
RewriteRule ^api/(.*)$ api/index.php [QSA,L]

# Redirigir raíz al nuevo sistema
RewriteRule ^$ public/index.php [L]

# Todas las demás rutas van al nuevo punto de entrada
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ public/index.php [QSA,L]

# ============================================================================
# HEADERS DE SEGURIDAD
# ============================================================================

<IfModule mod_headers.c>
    # Prevenir clickjacking
    Header set X-Frame-Options "SAMEORIGIN"
    
    # Prevenir MIME sniffing
    Header set X-Content-Type-Options "nosniff"
    
    # XSS Protection básica
    Header set X-XSS-Protection "1; mode=block"
    
    # CORS básico para desarrollo
    Header set Access-Control-Allow-Origin "http://crm-ligeros.test"
    Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With, X-CSRF-Token"
    Header set Access-Control-Allow-Credentials "true"
    
    # Ocultar información del servidor
    Header unset Server
    Header unset X-Powered-By
    
    # Cache para recursos estáticos
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$">
        Header set Cache-Control "public, max-age=86400"
        Header set Expires "Thu, 01 Jan 2025 00:00:00 GMT"
    </FilesMatch>
    
    # No cache para archivos PHP y HTML
    <FilesMatch "\.(php|html)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
        Header set Pragma "no-cache"
        Header set Expires "0"
    </FilesMatch>
</IfModule>

# ============================================================================
# COMPRESIÓN
# ============================================================================

<IfModule mod_deflate.c>
    # Comprimir texto
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE text/javascript
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/json
    AddOutputFilterByType DEFLATE application/xml
</IfModule>

# ============================================================================
# CONFIGURACIÓN DE SEGURIDAD ADICIONAL
# ============================================================================

# Limitar tamaño de upload (10MB)
LimitRequestBody 10485760

# ============================================================================
# PÁGINAS DE ERROR PERSONALIZADAS
# ============================================================================

ErrorDocument 403 "Acceso denegado"
ErrorDocument 404 "Página no encontrada"
ErrorDocument 500 "Error interno del servidor"